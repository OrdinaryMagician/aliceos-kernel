/*
	vgamodeset.c : VGA mode setting.
	(C)2012-2013 Marisa Kirisame, UnSX Team.
	Part of AliceOS, the Alice Operating System.
	Released under the MIT License.
	
	[DEPRECATED]
*/
#include <vgamodeset.h>

/* register settings for each mode */

/* mode 3h (80x25 text 16 colors) */
Uint8 mode3h[] =
{
	/* MISC */
	0x67,
	/* SEQ */
	0x03, 0x00, 0x03, 0x00, 0x02,
	/* CRTC */
	0x5F, 0x4F, 0x50, 0x82, 0x55, 0x81, 0xBF, 0x1F,
	0x00, 0x4F, 0x0D, 0x0E, 0x00, 0x00, 0x00, 0x50,
	0x9C, 0x0E, 0x8F, 0x28, 0x1F, 0x96, 0xB9, 0xA3,
	0xFF,
	/* GC */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x0E, 0x00,
	0xFF,
	/* AC */
	0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x14, 0x07,
	0x38, 0x39, 0x3A, 0x3B, 0x3C, 0x3D, 0x3E, 0x3F,
	0x0C, 0x00, 0x0F, 0x08, 0x00
};

/* mode 12h (640x480 planar 16 colors) */
Uint8 mode12h[] =
{
	/* MISC */
	0xE3,
	/* SEQ */
	0x03, 0x01, 0x08, 0x00, 0x06,
	/* CRTC */
	0x5F, 0x4F, 0x50, 0x82, 0x54, 0x80, 0x0B, 0x3E,
	0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0xEA, 0x0C, 0xDF, 0x28, 0x00, 0xE7, 0x04, 0xE3,
	0xFF,
	/* GC */
	0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x05, 0x0F,
	0xFF,
	/* AC */
	0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x14, 0x07,
	0x38, 0x39, 0x3A, 0x3B, 0x3C, 0x3D, 0x3E, 0x3F,
	0x01, 0x00, 0x0F, 0x00, 0x00
};

/* mode 13h (320x200 linear 256 colors) */
Uint8 mode13h[] =
{
	/* MISC */
	0x63,
	/* SEQ */
	0x03, 0x01, 0x0F, 0x00, 0x0E,
	/* CRTC */
	0x5F, 0x4F, 0x50, 0x82, 0x54, 0x80, 0xBF, 0x1F,
	0x00, 0x41, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x9C, 0x0E, 0x8F, 0x28, 0x40, 0x96, 0xB9, 0xA3,
	0xFF,
	/* GC */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x05, 0x0F,
	0xFF,
	/* AC */
	0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
	0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F,
	0x41, 0x00, 0x0F, 0x00, 0x00
};

/* set video mode - return 1 on failure, 0 on success */
Uint8 vga_modeset( Uint8 mode )
{
	int i;
	Uint8 *regs;
	Uint8 reg;
	switch ( mode )
	{
	case MODE_3H:
		regs = &mode3h[0];
		break;
	case MODE_12H:
		regs = &mode12h[0];
		break;
	case MODE_13H:
		regs = &mode13h[0];
		break;
	default:
		return 1;
	}

	/* blank display */
	vga_blank();

	/* MISC */
	outport_b(VGA_MSCOUTW,*regs);
	regs++;
	/* SEQ */
	for ( i=0; i<5; i++ )
		vga_setreg(VGA_SEQ,i,*(regs++));
	/* need to unlock CRTC here */
	reg = vga_getreg(VGA_CRTC,VGA_CRTC_EHBLNK);
	reg |= 0x80;
	vga_setreg(VGA_CRTC,VGA_CRTC_EHBLNK,reg);
	reg = vga_getreg(VGA_CRTC,VGA_CRTC_VTRTEN);
	reg &= ~0x80;
	vga_setreg(VGA_CRTC,VGA_CRTC_VTRTEN,reg);
	/* keep 'em unlocked */
	regs[VGA_CRTC_EHBLNK] |= 0x80;
	regs[VGA_CRTC_VTRTEN] &= ~0x80;
	/* CRTC */
	for ( i=0; i<25; i++ )
		vga_setreg(VGA_CRTC,i,*(regs++));
	/* GC */
	for ( i=0; i<9; i++ )
		vga_setreg(VGA_GC,i,*(regs++));
	/* AC */
	for ( i=0; i<9; i++ )
	{
		inport_b(VGA_INSTAT1);
		outport_b(VGA_AC_I,i);
		outport_b(VGA_AC_W,*(regs++));
	}
	/* unblank display and lock palette */
	vga_unblank();
	inport_b(VGA_INSTAT1);
	outport_b(VGA_AC_I,0x20);

	/* clear video memory */
	memset((Uint8*)0xA0000,0x00,262144);

	/* if text mode, load font */
	if ( mode == MODE_3H )
		vga_setfont(&biosfnt[0]);

	return 0;
}
